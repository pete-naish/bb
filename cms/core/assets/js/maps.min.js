if(typeof Perch=="undefined"){Perch={};Perch.UI={};Perch.Apps={}}Perch.UI.Maps=function(){var e=function(){t();$(window).on("Perch_Init_Editors",t)},t=function(){var e=$("input.map_adr");e.length&&e.each(function(e,t){var s=$(t);if(!s.attr("data-map-built")){s.attr("data-map-built",!0);var o=s.parent().find("div.map"),u=o.find("img").remove(),a=!1,f=$('<div class="mapdiv"></div>').appendTo(o);f.css({width:o.attr("data-width"),height:o.attr("data-height")});var l=o.attr("data-mapid");if(r(l,"clat"))var c=new google.maps.LatLng(r(l,"clat"),r(l,"clng")),h={zoom:parseInt(r(l,"zoom"),10),center:c,mapTypeId:n(r(l,"type"))};else{var h={zoom:10,center:new google.maps.LatLng(51.5,-0.11),mapTypeId:n("roadmap")};a=!0}var p=new google.maps.Map(f.get(0),h),d=new google.maps.LatLng(r(l,"lat"),r(l,"lng")),v=new google.maps.Marker({position:d,map:p});google.maps.event.addListener(p,"zoom_changed",function(){i(l,"zoom",p.getZoom())});google.maps.event.addListener(p,"center_changed",function(){var e=p.getCenter();i(l,"clat",e.lat());i(l,"clng",e.lng())});google.maps.event.addListener(p,"maptypeid_changed",function(){i(l,"type",p.getMapTypeId())});google.maps.event.addListener(p,"click",function(e){var t=e.latLng.lat(),n=e.latLng.lng();v.setPosition(new google.maps.LatLng(t,n));i(l,"lat",t);i(l,"lng",n)});var m=$('<a href="#" class="compact-button">'+o.attr("data-btn-label")+"</a>");m.insertAfter(s);m.click(function(e){e.preventDefault();o.removeClass("offscreen");var t=$(this).parent().find("input.map_adr").val();geocoder=new google.maps.Geocoder;geocoder.geocode({address:t},function(e,t){if(t==google.maps.GeocoderStatus.OK){p.setCenter(e[0].geometry.location);v.setPosition(e[0].geometry.location);i(l,"lat",e[0].geometry.location.lat());i(l,"lng",e[0].geometry.location.lng())}})});a&&o.addClass("offscreen")}})},n=function(e){switch(e){case"roadmap":return google.maps.MapTypeId.ROADMAP;case"satellite":return google.maps.MapTypeId.SATELLITE;case"hybrid":return google.maps.MapTypeId.HYBRID;case"terrain":return google.maps.MapTypeId.TERRAIN;default:return google.maps.MapTypeId.ROADMAP}},r=function(e,t){var n=$("#"+e+"_"+t);if(n.length)return n.val();$("div[data-mapid="+e+"]").append('<input type="hidden" name="'+e+"_"+t+'" id="'+e+"_"+t+'" value="" />');return!1},i=function(e,t,n){r(e,t);$("#"+e+"_"+t).val(n)};return{init:e}}();jQuery(function(e){Perch.UI.Maps.init()});